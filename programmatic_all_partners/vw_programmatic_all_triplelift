## view name: vw_programmatic_all_triplelift
## description: create partner view for programmatic_all that utilizes raw data and standardizes logic within prog_all
## created by: bj.hollowell@meredith.com
## Last modified on: 3/2/2022
## Last modified by: bj.hollowell@meredith.com
## Change log: limiting fields pulled in from raw data source
##
##
## notes:
##

WITH

prog_tag_map AS (
    SELECT
        * EXCEPT(tag_site),
        tag_site AS tag_site_map
    FROM `meredith-switchboard.summary_reports.programmatic_tag_mapping`
),

triplelift_base AS (
    SELECT
        report_date,
        Publisher_name,
        Placement_name,
        supply_source,
        deal_name,
        device_type,
        country_name,
        buyer_member,
        brand,
        deal_code,
        revenue,
        rendered
    FROM `meredith-switchboard.triplelift.triplelift_api_*`
    WHERE report_date >= '2020-01-01'
),

triplelift_cleaned AS (
    SELECT
        'TripleLift API' AS source,
        CAST(report_date AS TIMESTAMP) AS date,
        'TripleLift' AS partner,
        CONCAT('TripleLift',';',Publisher_name,';',Placement_name,';',supply_source) AS tag_site,
        --site,
        --'Unknown' AS tier,
        CASE
            WHEN deal_name = '%N/A%' THEN 'Open'
            WHEN deal_name = ' '     THEN 'Open'
            WHEN deal_name IS NULL   THEN 'Open'
            ELSE 'PMP'
            END AS transaction_type,
        '' AS ad_size_initial,
        '' AS ad_size,
        CASE
            WHEN placement_name LIKE '%Meredith_video%' THEN 'Video'
            WHEN placement_name LIKE '%android%'        THEN 'App'
            WHEN placement_name LIKE '%Android%'        THEN 'App'
            WHEN supply_source LIKE '%Direct%'          THEN "NonGam Display"
            ELSE "Display"
            END AS ad_type,
        CASE
            WHEN supply_source LIKE '%Direct%' THEN 'Selectable Tag'
            ELSE "TAM"
            END AS path_type,
        CASE
            WHEN device_type = 'Desktop' THEN 'Desktop'
            WHEN device_type = 'Tablet'  THEN 'Desktop'
            WHEN device_type  = 'Phone'  THEN 'MobileWeb'
            ELSE 'Unknown'
            END AS device_type,
        country_name as country_initial,
        CASE
            WHEN country_name LIKE '%United States%' THEN 'USA'
            WHEN country_name IS NULL                THEN 'Unknown'
            ELSE 'XUS'
            END AS country,
        device_type AS device_Type_initial,
        buyer_member AS dsp_initial,
        '' AS buyer_initial,
        brand AS advertiser_initial,
        deal_code AS deal_id,
        deal_name AS deal_name,
        revenue AS net_revenue,
        revenue AS gross_revenue,
        rendered AS Imps,
        NULL AS active_view_measured_impressions,
        NULL AS active_view_viewed_impressions,
        NULL AS bid_requests,
        NULL AS bid_responses
    FROM triplelift_base
),

triplelift_final AS (
    SELECT
        source,
        date,
        partner,
        tag_site,
        transaction_type,
        --site,
        --tier,
        ad_size_initial,
        B.adsize AS ad_size,
        ad_type,
        path_type,
        device_type_initial,
        device_type,
        country_initial,
        A.country,
        dsp_initial,
        buyer_initial,
        advertiser_initial,
        deal_id,
        deal_name,
        SUM(net_revenue) AS net_revenue,
        SUM(gross_revenue) AS gross_revenue,
        SUM(imps) AS imps,
        SUM(active_view_measured_impressions) AS active_view_measured_impressions,
        SUM(active_view_viewed_impressions) AS active_view_viewed_impressions,
        SUM(bid_requests) AS bid_requests,
        SUM(bid_responses) AS bid_responses
    FROM triplelift_cleaned A

    LEFT JOIN prog_tag_map B
    ON A.tag_site = B.tag_site_map

    GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18
)

SELECT * FROM triplelift_final
