WITH
  AdX_programmatic_all_untagged AS(
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_AdX_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_AdX_API_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_AdX_GAM_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_AdX_API_PG_and_PD_programmatic_all` ),

  AdX_programmatic_all_tagged AS (
  SELECT
    A.Source,
    DATE(A.Date) AS Date,
    A.Partner,
    A.Tag_Site,
    B.Site,
    B.Tier,
    A.Net_Revenue,
  FROM
    AdX_programmatic_all_untagged AS A
  LEFT JOIN
    `meredith-switchboard.summary_reports.programmatic_tag_mapping` AS B
  ON
    A.Tag_Site = B.Tag_Site
  ),

  programmatic_all_untagged AS(
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_Index_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_trustx_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.teads_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_amazon_open_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.amazon_pmp_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_rubicon_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_roundel_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.openx_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_pubmatic_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_spotx_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_Appnexus_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
   `meredith-switchboard.programmatic_all.vw_medianet_programmatic_all`
   UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_rogers_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_LiveIntent_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_nativo_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.Adsense_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_solve_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Ste,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.Kargo_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_gumgum_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.Outbrain_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.video_intelligence_*`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_youtube_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_yieldmo_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_triplelift_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_power_inbox_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_aax_programmatic_all`
  UNION ALL
  SELECT
    Date,
    Source,
    Partner,
    Tag_Site,
    Net_Revenue
  FROM
    `meredith-switchboard.programmatic_all.vw_verizon_programmatic_all`
  ),

  programmatic_all_tagged AS (
  SELECT
    A.Source,
    DATE(A.Date) AS Date,
    A.Partner,
    A.Tag_Site,
    B.Site,
    CASE
      WHEN Source = "Outbrain API" THEN "NoTier"
      WHEN Source = "Kargo Email" THEN "Unknown"
      WHEN Source = "VI API" THEN "NoTier"
      WHEN Source = "YouTube API" THEN "NoTier"
      WHEN Source = "SpotX custom API" THEN "NoTier"
      WHEN Source = "Media.net API2" THEN "NoTier"
      WHEN Source = "Solve Email" THEN "NoTier"
    ELSE
      B.Tier
    END
      AS Tier,
    A.Net_Revenue,
  FROM
    programmatic_all_untagged AS A
  LEFT JOIN
    `meredith-switchboard.summary_reports.programmatic_tag_mapping` AS B
  ON
    A.Tag_Site = B.Tag_Site
),

  Pacific_prog_all AS (
    SELECT
      A.Source,
      DATE(A.Date) AS Date,
      A.Partner,
      A.Tag_Site,
      A.Site,
      A.Tier,
      A.Net_Revenue,
    FROM
      `meredith-switchboard.programmatic_all.Pacific`  AS A
),

  programmatic_all AS(
  SELECT
    *
  FROM
    AdX_programmatic_all_tagged
  UNION ALL
  SELECT
    *
  FROM
    programmatic_all_tagged
  UNION ALL
  SELECT
    *
  FROM
    Pacific_prog_all),


programmatic_all_tag_site_final AS (
SELECT
  Tag_Site,
  Partner,
  Source,
  SUM(Net_Revenue) AS Net_Revenue,
  MIN(date) AS min_date,
  MAX(date) AS max_date
FROM programmatic_all
WHERE site IS NULL AND Date >= (CURRENT_DATE() - 30)
GROUP BY
  Tag_Site,
  Partner,
  Source
)

SELECT *
FROM programmatic_all_tag_site_final
ORDER BY Net_Revenue desc
